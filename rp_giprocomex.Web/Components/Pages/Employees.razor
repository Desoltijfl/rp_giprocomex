@page "/employees"
@using rp_giprocomex.Core.Models
@inject rp_giprocomex.Services.EmployeeService EmployeeService
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="employees-wrap">
    <div class="employees-container">
        <div class="employees-header">
            <div class="header-left">
                <h1 class="page-title">Empleados</h1>
                <div class="page-sub">Listado de colaboradores y vencimientos contractuales</div>
            </div>

            <div class="actions">
                <a class="btn small" href="/employees/edit">+ Nuevo empleado</a>
                <button type="button" class="btn secondary small" @onclick="Load">Actualizar</button>
            </div>
        </div>

        <div class="search-row">
            <div class="search-box" role="search" aria-label="Buscar empleados">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#6c757d" viewBox="0 0 16 16">
                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 1.415-1.415l-3.85-3.85zm-5.242.656a5 5 0 1 1 0-10 5 5 0 0 1 0 10z" />
                </svg>
                <input placeholder="Buscar por nombre, puesto u oficina..." @bind="search" @bind:event="oninput" />
                <div class="search-actions">
                    <button class="btn small" @onclick="Load">Buscar</button>
                </div>
            </div>
        </div>

        <div class="table-card">
            <div class="table-responsive">
                <table class="employees-table" aria-describedby="employees-table">
                    <thead>
                        <tr>
                            <th style="width:56px">#</th>
                            <th>Puesto</th>
                            <th>Oficina</th>
                            <th>Empresa</th>
                            <th>Registro</th>
                            <th>Nombre</th>
                            <th>Ingreso</th>
                            <th>Antigüedad</th>
                            <th>Fecha Término</th>
                            <th>Renovación - Término</th>
                            <th>Indeterminado</th>
                            <th style="width:140px"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (employees == null)
                        {
                            <tr><td colspan="12">Cargando...</td></tr>
                        }
                        else if (employees.Count == 0)
                        {
                            <tr><td colspan="12">No hay empleados.</td></tr>
                        }
                        else
                        {
                            @foreach (var e in employees)
                            {
                                <tr>
                                    <td>@e.Numero</td>
                                    <td>@e.Puesto</td>
                                    <td>@e.Oficina</td>
                                    <td>@e.Empresa</td>
                                    <td>@e.RegistroPatronal</td>
                                    <td style="font-weight:600">@e.NombreCompleto</td>
                                    <td>@(e.FechaIngreso.ToString("yyyy-MM-dd"))</td>
                                    <td><span class="badge">@e.Aniversario</span></td>
                                    <td>@(e.FechaTermino.HasValue? e.FechaTermino.Value.ToString("yyyy-MM-dd") : "-")</td>
                                    <td>@(e.RenovacionTermino.HasValue? e.RenovacionTermino.Value.ToString("yyyy-MM-dd") : "-")</td>
                                    <td>@(e.Indeterminado ? "Sí" : "No")</td>
                                    <td>
                                        <a class="action-link" href="@($"/employees/edit/{e.Id}")">Editar</a>
                                        <span style="padding:0 8px;color:#bbb">|</span>
                                        <button class="action-link" style="background:none;border:0;padding:0;cursor:pointer" @onclick="@(async () => await DeleteAsync(e.Id))">Borrar</button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            <div class="table-footer">
                <div>@(employees?.Count ?? 0) empleados</div>
                <div class="table-controls">
                    <!-- espacio para paginación futura -->
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<Employee> employees = new();
    private string? search;

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        try
        {
            employees = string.IsNullOrWhiteSpace(search)
                ? await EmployeeService.GetAllAsync()
                : await EmployeeService.SearchAsync(search);
        }
        catch (Exception ex)
        {
            // opcional: loguear o mostrar error al usuario
            Console.Error.WriteLine(ex);
            employees = new List<Employee>();
        }
        StateHasChanged();
    }

    private async Task DeleteAsync(int id)
    {
        try
        {
            // Confirm using browser confirm dialog via JS interop
            var confirmed = false;
            try
            {
                confirmed = await JS.InvokeAsync<bool>("confirm", $"¿Eliminar empleado #{id}?");
            }
            catch
            {
                // si JS falla, asumir confirm true para no bloquear en entornos sin JS
                confirmed = true;
            }

            if (!confirmed) return;

            await EmployeeService.DeleteAsync(id);
            await Load();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex);
            // opcional: mostrar notificación de error
        }
    }
}