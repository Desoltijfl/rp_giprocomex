@page "/employees/edit"
@page "/employees/edit/{Id:int}"
@inject rp_giprocomex.Services.EmployeeService EmployeeService
@inject NavigationManager Nav
@using rp_giprocomex.Core.Models
@using Microsoft.AspNetCore.Components.Forms

<h3>@(isNew ? "Nuevo empleado" : "Editar empleado")</h3>

<EditForm Model="employee" OnValidSubmit="SaveAsync">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="row">
        <div class="col-md-2 mb-2">
            <label>Número</label>
            <InputNumber class="form-control" @bind-Value="employee.Numero" />
        </div>
        <div class="col-md-4 mb-2">
            <label>Puesto</label>
            <InputText class="form-control" @bind-Value="employee.Puesto" />
        </div>
        <div class="col-md-3 mb-2">
            <label>Oficina</label>
            <InputText class="form-control" @bind-Value="employee.Oficina" />
        </div>
        <div class="col-md-3 mb-2">
            <label>Empresa</label>
            <InputText class="form-control" @bind-Value="employee.Empresa" />
        </div>

        <div class="col-md-3 mb-2">
            <label>Registro Patronal</label>
            <InputText class="form-control" @bind-Value="employee.RegistroPatronal" />
        </div>
        <div class="col-md-3 mb-2">
            <label>Siroc</label>
            <InputText class="form-control" @bind-Value="employee.Siroc" />
        </div>

        <div class="col-12 mb-2">
            <label>Nombre completo</label>
            <InputText class="form-control" @bind-Value="employee.NombreCompleto" />
        </div>

        <div class="col-md-3 mb-2">
            <label>Fecha Ingreso</label>
            <InputDate class="form-control" @bind-Value="employee.FechaIngreso" onchange="@((ChangeEventArgs __e) => OnFechaIngresoChanged())" />
        </div>

        <div class="col-md-3 mb-2">
            <label>Fecha Término</label>
            <InputDate<DateTime?> class="form-control" Value="employee.FechaTermino" Disabled="true" />
        </div>

        <div class="col-md-3 mb-2">
            <label>Renovación (inicio)</label>
            <InputDate<DateTime?> class="form-control" Value="employee.Renovacion" Disabled="true" />
        </div>

        <div class="col-md-3 mb-2">
            <label>Renovación - Término</label>
            <InputDate<DateTime?> class="form-control" Value="employee.RenovacionTermino" Disabled="true" />
        </div>

        <div class="col-md-3 form-check mb-3">
            <InputCheckbox class="form-check-input" @bind-Value="employee.Indeterminado" @onchange="OnIndeterminadoChanged" />
            <label class="form-check-label">Indeterminado</label>
        </div>
    </div>

    <div class="mt-3">
        <button class="btn btn-primary" type="submit">Guardar</button>
        <button class="btn btn-secondary ms-2" type="button" @onclick="Cancel">Cancelar</button>
    </div>
</EditForm>

@code {
    [Parameter] public int? Id { get; set; }

    private Employee employee = new Employee();
    private bool isNew = true;

    protected override async Task OnInitializedAsync()
    {
        if (Id.HasValue)
        {
            var e = await EmployeeService.GetByIdAsync(Id.Value);
            if (e != null)
            {
                employee = e;
                isNew = false;
            }
            else
            {
                Nav.NavigateTo("/employees");
            }
        }
        else
        {
            employee = new Employee
            {
                FechaIngreso = DateTime.Today,
                Indeterminado = false
            };

            CalculateDatesClient();
        }
    }

    private void CalculateDatesClient()
    {
        if (employee.Indeterminado)
        {
            employee.FechaTermino = null;
            employee.Renovacion = null;
            employee.RenovacionTermino = null;
            return;
        }

        if (employee.FechaIngreso == default)
            employee.FechaIngreso = DateTime.Today;

        employee.FechaTermino = employee.FechaIngreso.AddDays(90);
        employee.Renovacion = employee.FechaTermino;
        employee.RenovacionTermino = employee.Renovacion?.AddDays(90);
    }

    private void OnFechaIngresoChanged()
    {
        CalculateDatesClient();
        StateHasChanged();
    }

    private void OnIndeterminadoChanged(ChangeEventArgs e)
    {
        if (employee.Indeterminado)
        {
            employee.FechaTermino = null;
            employee.Renovacion = null;
            employee.RenovacionTermino = null;
        }
        else
        {
            CalculateDatesClient();
        }
    }

    private async Task SaveAsync()
    {
        // El servicio recalcula de nuevo en server-side por seguridad
        if (isNew)
            await EmployeeService.AddAsync(employee);
        else
            await EmployeeService.UpdateAsync(employee);

        Nav.NavigateTo("/employees");
    }

    private void Cancel() => Nav.NavigateTo("/employees");
}